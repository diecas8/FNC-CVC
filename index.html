<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Geoportal - Seguridad Alimentaria | FNC y CVC</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: #e9f7ef;
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
            padding: 10px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            height: 100vh;
        }
        
        header {
            background: linear-gradient(to right, #1a5f23, #2e7d32);
            color: white;
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            border-bottom: 3px solid #0d3c14;
            z-index: 10;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .logo {
            width: 45px;
            height: 45px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #2e7d32;
            font-size: 9px;
            text-align: center;
            padding: 3px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        
        h1 {
            font-size: 16px;
            font-weight: 700;
            line-height: 1.2;
        }
        
        .subtitle {
            font-size: 11px;
            opacity: 0.9;
            margin-top: 2px;
            font-weight: 300;
        }
        
        #current-date {
            font-size: 11px;
            text-align: right;
            min-width: 90px;
        }
        
        .map-container {
            flex: 1;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            position: relative;
        }
        
        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
        }
        
        .floating-controls {
            position: absolute;
            bottom: 15px;
            right: 10px;
            display: flex;
            flex-direction: row;
            gap: 8px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px;
            border-radius: 25px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
            flex-wrap: wrap;
            max-width: calc(100% - 20px);
            justify-content: center;
        }
        
        .floating-btn {
            background: white;
            color: #2e7d32;
            border: none;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.12);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .floating-btn:hover, .floating-btn:active {
            background: #2e7d32;
            color: white;
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.18);
        }
        
        .floating-btn.active {
            background: #2e7d32;
            color: white;
        }
        
        .floating-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 2000;
            display: none;
            overflow-y: auto;
            padding: 15px;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.15);
        }
        
        .floating-panel.active {
            display: block;
            transform: translateY(0);
        }
        
        .panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid #2e7d32;
            margin-bottom: 15px;
        }
        
        .panel h2 {
            font-size: 18px;
            margin-bottom: 12px;
            color: #2e7d32;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
            font-size: 14px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            background: #fff;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2e7d32;
            box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2);
        }
        
        textarea {
            height: 80px;
            resize: vertical;
        }
        
        .coordinates {
            background: #e8f5e9;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            margin: 8px 0;
            font-size: 13px;
            border-left: 3px solid #2e7d32;
        }
        
        .btn {
            background: #2e7d32;
            color: white;
            border: none;
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .btn:hover, .btn:active {
            background: #1b5e20;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .btn-secondary {
            background: #5c6bc0;
        }
        
        .btn-secondary:hover, .btn-secondary:active {
            background: #3f51b5;
        }
        
        .btn-print {
            background: #1565c0;
        }
        
        .btn-print:hover, .btn-print:active {
            background: #0d47a1;
        }
        
        .btn-edit {
            background: #ff9800;
        }
        
        .btn-edit:hover, .btn-edit:active {
            background: #f57c00;
        }
        
        .btn-delete {
            background: #f44336;
        }
        
        .btn-delete:hover, .btn-delete:active {
            background: #d32f2f;
        }
        
        .btn-csv {
            background: #9c27b0;
        }
        
        .btn-csv:hover, .btn-csv:active {
            background: #7b1fa2;
        }
        
        .btn-export {
            background: #4caf50;
        }
        
        .btn-export:hover, .btn-export:active {
            background: #388e3c;
        }
        
        .data-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
            border-left: 3px solid #4caf50;
            position: relative;
            transition: all 0.3s;
        }
        
        .data-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .data-item h3 {
            font-size: 15px;
            color: #1b5e20;
            margin-bottom: 5px;
        }
        
        .data-item p {
            font-size: 13px;
            color: #555;
            margin: 3px 0;
            line-height: 1.4;
        }
        
        .data-item .actions {
            display: flex;
            gap: 6px;
            margin-top: 10px;
        }
        
        .data-item .actions .btn {
            padding: 8px 10px;
            font-size: 13px;
        }
        
        .legend {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 8px;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
            max-width: 160px;
            border: 1px solid #e0e0e0;
        }
        
        .legend-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2e7d32;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 6px 0;
            font-size: 12px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        }
        
        .color-finca {
            background: #e91e63;
        }
        
        .color-beneficiario {
            background: #2196f3;
        }
        
        .color-ubicacion {
            background: #ff9800;
        }
        
        .color-edit {
            background: #ffc107;
        }
        
        .color-csv {
            background: #9c27b0;
        }
        
        .color-new {
            background: #4caf50;
        }
        
        .print-container {
            position: absolute;
            left: -9999px;
            width: 21cm;
            height: 29.7cm;
            padding: 1cm;
            background: white;
        }
        
        footer {
            text-align: center;
            padding: 12px;
            color: #666;
            font-size: 11px;
            display: flex;
            flex-direction: column;
            gap: 3px;
            background: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }
        
        .search-container {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .search-container input {
            flex-grow: 1;
        }
        
        .search-container button {
            width: auto;
            padding: 10px 12px;
            min-width: 50px;
        }
        
        .instructions-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
            display: none;
        }
        
        .instructions-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.25);
        }
        
        .instructions-content h2 {
            color: #2e7d32;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
        }
        
        .instructions-content ul {
            padding-left: 20px;
            margin: 15px 0;
        }
        
        .instructions-content li {
            margin-bottom: 12px;
            line-height: 1.5;
            font-size: 14px;
        }
        
        .close-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: #f44336;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .close-btn:hover, .close-btn:active {
            transform: rotate(90deg) scale(1.1);
        }
        
        .close-panel-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #f44336;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        
        .csv-upload-container {
            margin: 12px 0;
            padding: 12px;
            background: #f3e5f5;
            border-radius: 8px;
            border: 2px dashed #9c27b0;
        }
        
        .csv-table-container {
            max-height: 250px;
            overflow-y: auto;
            margin-top: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        }
        
        .csv-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .csv-table th {
            background: #7b1fa2;
            color: white;
            padding: 10px;
            text-align: left;
            position: sticky;
            top: 0;
            font-weight: 500;
            font-size: 13px;
        }
        
        .csv-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }
        
        .csv-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .csv-table tr:hover {
            background-color: #f3e5f5;
        }
        
        .tab-container {
            display: flex;
            margin-bottom: 12px;
            border-bottom: 2px solid #2e7d32;
            background: #f8f9fa;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .tab {
            padding: 10px 12px;
            cursor: pointer;
            background: #f8f9fa;
            font-weight: 500;
            flex: 1;
            text-align: center;
            transition: all 0.3s;
            font-size: 13px;
        }
        
        .tab:hover, .tab:active {
            background: #e8f5e9;
        }
        
        .tab.active {
            background: #2e7d32;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Control de capas personalizado */
        .leaflet-control-layers {
            position: absolute;
            top: 70px;
            right: 10px;
            z-index: 1000;
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
            padding: 5px;
            border: 1px solid #e0e0e0;
        }
        
        .leaflet-control-layers-toggle {
            display: none;
        }
        
        .leaflet-control-layers-list {
            display: block !important;
        }
        
        .leaflet-control-layers-expanded {
            padding: 5px 8px;
        }
        
        .leaflet-control-layers-base {
            margin-bottom: 5px;
        }
        
        .leaflet-control-layers-base label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 3px 0;
            font-size: 13px;
        }
        
        .leaflet-control-layers-base input {
            margin-right: 6px;
        }
        
        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            z-index: 3000;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            pointer-events: none;
            max-width: 90%;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        /* Estadísticas */
        .stats-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .stat-card {
            flex: 1;
            min-width: 100px;
            background: white;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
            text-align: center;
            border-top: 3px solid #2e7d32;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #2e7d32;
            margin: 8px 0;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        
        /* Estilos para impresión */
        @media print {
            .floating-controls,
            .legend,
            .floating-panel,
            .leaflet-control-layers {
                display: none !important;
            }
            
            .map-container {
                height: 80vh;
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }
        
        @media (min-width: 768px) {
            .container {
                max-width: 95%;
                padding: 15px;
            }
            
            .map-container {
                height: 75vh;
            }
            
            .floating-controls {
                top: 15px;
                right: 15px;
                bottom: auto;
                flex-direction: column;
                max-width: 55px;
            }
            
            .floating-panel {
                position: absolute;
                top: 80px;
                right: 15px;
                left: auto;
                bottom: auto;
                width: 320px;
                max-height: calc(75vh - 100px);
                border-radius: 12px;
                transform: none;
                box-shadow: 0 6px 18px rgba(0,0,0,0.15);
            }
            
            .floating-panel.active {
                transform: none;
                display: block;
            }
            
            .close-panel-btn {
                display: block;
            }
            
            header {
                padding: 15px 20px;
            }
            
            .logo {
                width: 55px;
                height: 55px;
                font-size: 10px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            .subtitle {
                font-size: 14px;
            }
        }
        
        .elevation-info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            border-left: 3px solid #2196f3;
        }
        
        .elevation-value {
            font-weight: bold;
            color: #1976d2;
        }
        
        .map-credits {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            z-index: 1000;
        }
        
        /* Estilos para la ventana de impresión */
        .print-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 4000;
            display: flex;
            align-items: center;
            justify-content: center;
            display: none;
        }
        
        .print-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .print-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #2e7d32;
        }
        
        .print-map-container {
            height: 400px;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 15px;
            position: relative;
        }
        
        #print-map {
            height: 100%;
            width: 100%;
            position: relative;
        }
        
        .loading-map {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #2e7d32;
            font-size: 16px;
            font-weight: 500;
        }
        
        .print-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #2e7d32;
            margin-bottom: 15px;
        }
        
        .print-info h3 {
            color: #2e7d32;
            margin-bottom: 10px;
        }
        
        .print-info p {
            margin: 5px 0;
        }
        
        .print-controls {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }
        
        .print-close-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: #f44336;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .print-map-info-overlay {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            max-width: 300px;
        }
        
        .print-map-info-overlay h3 {
            color: #2e7d32;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .print-map-credits {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            z-index: 1000;
        }
        
        .print-search-container {
            margin-bottom: 15px;
        }
        
        .print-search-container input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .print-search-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }
        
        .print-search-result {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .print-search-result:hover {
            background-color: #e8f5e9;
            transform: translateY(-2px);
        }
        
        .print-search-result:last-child {
            border-bottom: none;
        }
        
        .print-search-result h4 {
            margin: 0 0 5px 0;
            color: #1b5e20;
        }
        
        .print-search-result p {
            margin: 0;
            font-size: 12px;
            color: #555;
        }
        
        .no-results {
            text-align: center;
            padding: 10px;
            color: #666;
            font-style: italic;
        }
        
        .print-btn-container {
            position: absolute;
            bottom: 80px;
            right: 10px;
            z-index: 1000;
        }
        
        /* Nuevos estilos para validación */
        .form-group.required label::after {
            content: " *";
            color: #f44336;
        }
        
        .form-error {
            color: #f44336;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }
        
        /* Botón de cierre visible en todos los dispositivos */
        .close-panel-btn {
            display: block !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-container">
                <div class="logo">FNC<br>&<br>CVC</div>
                <div>
                    <h1>Geoportal - Seguridad Alimentaria</h1>
                    <div class="subtitle">Convenio FNC y CVC | Valle del Cauca</div>
                </div>
            </div>
            <div id="current-date">14 de Julio, 2025</div>
        </header>
        
        <div class="map-container">
            <div id="map"></div>
            
            <div class="map-credits">© Leaflet | OpenStreetMap | Esri</div>
            
            <div class="floating-controls">
                <button id="form-btn" class="floating-btn" title="Mostrar formulario">
                    <i class="fas fa-edit"></i>
                </button>
                <button id="data-btn" class="floating-btn" title="Mostrar datos guardados">
                    <i class="fas fa-database"></i>
                </button>
                <button id="csv-btn" class="floating-btn" title="Cargar datos CSV">
                    <i class="fas fa-file-csv"></i>
                </button>
                <button id="location-btn" class="floating-btn" title="Centrar en mi ubicación">
                    <i class="fas fa-location-crosshairs"></i>
                </button>
                <button id="help-btn" class="floating-btn" title="Instrucciones de uso">
                    <i class="fas fa-question-circle"></i>
                </button>
            </div>
            
            <div class="print-btn-container">
                <button id="print-view-btn" class="floating-btn" title="Imprimir mapa de beneficiario">
                    <i class="fas fa-print"></i>
                </button>
            </div>
            
            <div class="legend">
                <div class="legend-title">
                    <i class="fas fa-map-pin"></i> Leyenda
                </div>
                <div class="legend-item">
                    <div class="legend-color color-finca"></div>
                    <span>Fincas</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color color-csv"></div>
                    <span>Datos CSV</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color color-ubicacion"></div>
                    <span>Su Ubicación</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color color-new"></div>
                    <span>Nuevo Registro</span>
                </div>
            </div>
        </div>
        
        <!-- Panel flotante para formulario -->
        <div id="form-panel" class="floating-panel">
            <button class="close-panel-btn">
                <i class="fas fa-times"></i>
            </button>
            <div class="panel">
                <h2><i class="fas fa-map-marker-alt"></i> Captura de Datos</h2>
                <div class="coordinates" id="coordinates">Haga clic en el mapa para capturar coordenadas</div>
                <div class="elevation-info" id="elevation-info">Altura sobre el nivel del mar: <span class="elevation-value" id="elevation-value">--</span> m</div>
                
                <div class="form-group required">
                    <label for="beneficiary">Nombre del Beneficiario</label>
                    <input type="text" id="beneficiary" placeholder="Ingrese el nombre completo">
                    <div class="form-error" id="beneficiary-error">Este campo es obligatorio</div>
                </div>
                
                <div class="form-group required">
                    <label for="farm">Nombre de la Finca</label>
                    <input type="text" id="farm" placeholder="Ingrese el nombre de la finca">
                    <div class="form-error" id="farm-error">Este campo es obligatorio</div>
                </div>
                
                <div class="form-group required">
                    <label for="crop">Cultivo Principal</label>
                    <select id="crop">
                        <option value="">Seleccione un cultivo</option>
                        <option value="cafe">Café</option>
                        <option value="platano">Plátano</option>
                        <option value="maiz">Maíz</option>
                        <option value="frijol">Frijol</option>
                        <option value="hortalizas">Hortalizas</option>
                        <option value="frutales">Frutales</option>
                        <option value="cacao">Cacao</option>
                    </select>
                    <div class="form-error" id="crop-error">Seleccione un cultivo</div>
                </div>
                
                <div class="form-group">
                    <label for="observations">Observaciones</label>
                    <textarea id="observations" placeholder="Ingrese observaciones adicionales"></textarea>
                </div>
                
                <button id="save-btn" class="btn">
                    <i class="fas fa-save"></i> Guardar Datos
                </button>
                <button id="cancel-edit-btn" class="btn btn-delete" style="display: none; margin-top: 10px;">
                    <i class="fas fa-times"></i> Cancelar Edición
                </button>
            </div>
        </div>
        
        <!-- Panel flotante para datos -->
        <div id="data-panel" class="floating-panel">
            <button class="close-panel-btn">
                <i class="fas fa-times"></i>
            </button>
            <div class="panel">
                <h2><i class="fas fa-search"></i> Consultar Datos</h2>
                
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-value" id="total-farms">0</div>
                        <div class="stat-label">Fincas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-beneficiaries">0</div>
                        <div class="stat-label">Beneficiarios</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="last-update">Hoy</div>
                        <div class="stat-label">Última Actualización</div>
                    </div>
                </div>
                
                <div class="search-container">
                    <input type="text" id="search-input" placeholder="Buscar por nombre o finca...">
                    <button id="search-btn" class="btn btn-secondary">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                
                <div id="data-list">
                    <!-- Los datos guardados aparecerán aquí -->
                </div>
                
                <div class="form-group" style="margin-top: 15px;">
                    <button id="export-btn" class="btn btn-export">
                        <i class="fas fa-file-export"></i> Exportar a CSV
                    </button>
                    <button id="clear-all-btn" class="btn btn-delete" style="margin-top: 10px;">
                        <i class="fas fa-trash"></i> Eliminar Todos
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Panel flotante para CSV -->
        <div id="csv-panel" class="floating-panel">
            <button class="close-panel-btn">
                <i class="fas fa-times"></i>
            </button>
            <div class="panel">
                <h2><i class="fas fa-file-csv"></i> Cargar Datos CSV</h2>
                
                <div class="csv-upload-container">
                    <div class="form-group">
                        <label for="csv-file">Seleccionar archivo CSV</label>
                        <input type="file" id="csv-file" accept=".csv">
                    </div>
                    
                    <div class="form-group">
                        <button id="load-csv-btn" class="btn btn-csv">
                            <i class="fas fa-upload"></i> Cargar Datos
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label>Estructura CSV esperada:</label>
                        <div class="coordinates">
                            Beneficiario,Finca,Cultivo,Latitud,Longitud
                        </div>
                    </div>
                </div>
                
                <div class="tab-container">
                    <div class="tab active" data-tab="csv-data">Datos CSV</div>
                    <div class="tab" data-tab="map-view">Visualización</div>
                </div>
                
                <div class="tab-content active" id="csv-data">
                    <div id="csv-table-container" class="csv-table-container">
                        <!-- Tabla de datos CSV aparecerá aquí -->
                    </div>
                </div>
                
                <div class="tab-content" id="map-view">
                    <div class="form-group">
                        <label>Datos cargados: <span id="csv-count">0</span> registros</label>
                    </div>
                    
                    <div class="form-group">
                        <button id="plot-csv-btn" class="btn btn-csv">
                            <i class="fas fa-map-marker-alt"></i> Mostrar en Mapa
                        </button>
                        <button id="clear-csv-btn" class="btn btn-delete" style="margin-top: 10px;">
                            <i class="fas fa-trash"></i> Limpiar Datos
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="instructions-overlay" id="instructions-overlay">
            <div class="instructions-content">
                <button class="close-btn" id="close-instructions">
                    <i class="fas fa-times"></i>
                </button>
                <h2><i class="fas fa-info-circle"></i> Instrucciones de Uso</h2>
                <ul>
                    <li><strong>Captura de datos:</strong> Haga clic en el botón <i class="fas fa-edit"></i> para mostrar el formulario. Luego haga clic en cualquier punto del mapa para capturar las coordenadas y complete los campos requeridos.</li>
                    <li><strong>Consulta de datos:</strong> Haga clic en el botón <i class="fas fa-database"></i> para ver todos los registros guardados. Puede buscar registros específicos utilizando el campo de búsqueda.</li>
                    <li><strong>Carga de CSV:</strong> Use el botón <i class="fas fa-file-csv"></i> para cargar datos desde archivos CSV.</li>
                    <li><strong>Ubicación:</strong> Use el botón <i class="fas fa-location-crosshairs"></i> para centrar el mapa en su posición actual.</li>
                    <li><strong>Altura sobre el nivel del mar:</strong> Se muestra automáticamente al seleccionar una ubicación en el mapa.</li>
                    <li><strong>Impresión:</strong> Use el botón <i class="fas fa-print"></i> para generar mapas con información de beneficiarios y un radio de 500 metros.</li>
                </ul>
                <p><strong>Nota:</strong> Los campos marcados con * son obligatorios para guardar un registro.</p>
                <div style="margin-top: 15px; background: #e8f5e9; padding: 12px; border-radius: 8px;">
                    <h3><i class="fas fa-lightbulb"></i> Consejos para Móviles</h3>
                    <ul>
                        <li>Toque con dos dedos y deslice para hacer zoom</li>
                        <li>Deslice con un dedo para desplazar el mapa</li>
                        <li>Toque un marcador para ver información detallada</li>
                        <li>Los datos se guardan automáticamente en su dispositivo</li>
                        <li>Los paneles se pueden cerrar tocando la X en la esquina superior derecha</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="toast" id="toast">
            <i class="fas fa-check-circle"></i>
            <span id="toast-message">Operación completada</span>
        </div>
        
        <footer>
            <p>Sistema Geoportal para Seguridad Alimentaria - FNC y CVC</p>
            <p>Desarrollado por Diego Castaño | Especialista en SIG | © 2025</p>
            <p>Datos almacenados localmente</p>
        </footer>
    </div>
    
    <!-- Contenedor oculto para impresión -->
    <div id="print-container" class="print-container"></div>

    <!-- Ventana de impresión de mapas -->
    <div class="print-overlay" id="print-overlay">
        <div class="print-content">
            <button class="print-close-btn" id="print-close-btn">
                <i class="fas fa-times"></i>
            </button>
            
            <div class="print-header">
                <div>
                    <h2>Mapa del Beneficiario</h2>
                    <p>Radio de 500 metros alrededor de la ubicación</p>
                </div>
                <div class="logo-container">
                    <div class="logo">FNC<br>&<br>CVC</div>
                    <div>
                        <div class="subtitle">Geoportal - Seguridad Alimentaria</div>
                    </div>
                </div>
            </div>
            
            <div class="print-search-container">
                <input type="text" id="print-search-input" placeholder="Buscar beneficiario por nombre..." autocomplete="off">
                <div class="print-search-results" id="print-search-results">
                    <div class="no-results">Ingrese al menos 3 caracteres para buscar</div>
                </div>
            </div>
            
            <div class="print-map-container">
                <div id="print-map"></div>
                <div class="print-map-info-overlay" id="print-map-info-overlay">
                    <h3 id="print-farm-name">Nombre de la Finca</h3>
                    <p><strong>Beneficiario:</strong> <span id="print-beneficiary">Nombre del Beneficiario</span></p>
                    <p><strong>Cultivo:</strong> <span id="print-crop">Cultivo Principal</span></p>
                    <p><strong>Ubicación:</strong> <span id="print-coords">Lat: 0.000000, Lng: 0.000000</span></p>
                    <p><strong>Altura:</strong> <span id="print-elevation">--</span> m</p>
                    <p><strong>Fecha:</strong> <span id="print-date">Fecha de registro</span></p>
                </div>
                <div class="print-map-credits">© Leaflet | OpenStreetMap | Esri</div>
            </div>
            
            <div class="print-info">
                <h3>Información Adicional</h3>
                <p><strong>Observaciones:</strong> <span id="print-observations">Ninguna</span></p>
                <p><strong>Radio:</strong> 500 metros alrededor de la ubicación</p>
                <p><strong>Fecha de impresión:</strong> <span id="print-current-date">Fecha actual</span></p>
            </div>
            
            <div class="print-controls">
                <button id="print-map-btn" class="btn btn-print" disabled>
                    <i class="fas fa-print"></i> Imprimir Mapa
                </button>
                <button id="close-print-btn" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cerrar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Inicializar mapa
        const map = L.map('map').setView([3.4516, -76.5320], 10); // Centro en Valle del Cauca
        
        // Capas base
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        });
        
        const esriLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, Maxar, Earthstar Geographics'
        });
        
        // Capa base por defecto
        esriLayer.addTo(map);
        
        // Control de capas personalizado
        const baseLayers = {
            "Esri Satelital": esriLayer,
            "OpenStreetMap": osmLayer
        };
        
        // Variables para almacenamiento
        let currentCoords = null;
        let currentElevation = null;
        let farmData = JSON.parse(localStorage.getItem('farmData')) || [];
        let tempMarkers = [];
        let userMarker = null;
        let editingId = null;
        let csvData = JSON.parse(localStorage.getItem('csvData')) || [];
        let printMapInstance = null;
        let currentPrintData = null;
        let activePanel = null;
        
        // Grupos de clústeres para evitar superposición
        const farmCluster = L.markerClusterGroup({
            iconCreateFunction: function(cluster) {
                return L.divIcon({
                    html: '<div><span>' + cluster.getChildCount() + '</span></div>',
                    className: 'marker-cluster-custom',
                    iconSize: L.point(40, 40)
                });
            },
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true,
            maxClusterRadius: 60
        });
        
        const csvCluster = L.markerClusterGroup({
            iconCreateFunction: function(cluster) {
                return L.divIcon({
                    html: '<div><span>' + cluster.getChildCount() + '</span></div>',
                    className: 'marker-cluster-csv',
                    iconSize: L.point(40, 40)
                });
            },
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true,
            maxClusterRadius: 60
        });
        
        // Añadir grupos al mapa
        map.addLayer(farmCluster);
        map.addLayer(csvCluster);
        
        // Función para obtener la elevación desde Open-Elevation API
        async function getElevation(lat, lng) {
            try {
                const response = await fetch(`https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lng}`);
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    return data.results[0].elevation.toFixed(1);
                }
                return null;
            } catch (error) {
                console.error('Error obteniendo elevación:', error);
                return null;
            }
        }
        
        // Función para mostrar notificaciones toast
        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }
        
        // Función para guardar datos
        async function saveData() {
            if (!currentCoords || currentElevation === null) {
                showToast('Seleccione ubicación primero', 4000);
                return;
            }
            
            const beneficiary = document.getElementById('beneficiary').value;
            const farm = document.getElementById('farm').value;
            const crop = document.getElementById('crop').value;
            const observations = document.getElementById('observations').value;
            
            // Validar campos requeridos
            let isValid = true;
            
            if (!beneficiary) {
                document.getElementById('beneficiary-error').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('beneficiary-error').style.display = 'none';
            }
            
            if (!farm) {
                document.getElementById('farm-error').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('farm-error').style.display = 'none';
            }
            
            if (!crop) {
                document.getElementById('crop-error').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('crop-error').style.display = 'none';
            }
            
            if (!isValid) {
                showToast('Complete campos obligatorios', 4000);
                return;
            }
            
            // Crear objeto con los datos
            const data = {
                id: editingId || Date.now(),
                coords: currentCoords,
                elevation: currentElevation,
                beneficiary,
                farm,
                crop,
                observations,
                date: new Date().toLocaleDateString('es-CO')
            };
            
            if (editingId) {
                // Actualizar registro existente
                const index = farmData.findIndex(item => item.id === editingId);
                if (index !== -1) {
                    farmData[index] = data;
                }
                // Salir del modo edición
                cancelEdit();
                showToast('Registro actualizado');
            } else {
                // Nuevo registro
                farmData.push(data);
                showToast('Datos guardados');
            }
            
            // Guardar en localStorage
            localStorage.setItem('farmData', JSON.stringify(farmData));
            
            // Actualizar marcadores y lista
            updateMapMarkers();
            updateDataList();
            updateStats();
            
            // Limpiar formulario
            document.getElementById('beneficiary').value = '';
            document.getElementById('farm').value = '';
            document.getElementById('crop').value = '';
            document.getElementById('observations').value = '';
            document.getElementById('coordinates').textContent = 'Datos guardados! Seleccione nueva ubicación';
            document.getElementById('elevation-value').textContent = '--';
            currentCoords = null;
            currentElevation = null;
            clearTempMarkers();
        }
        
        // Función para obtener nombre del cultivo
        function getCropName(cropKey) {
            const crops = {
                'cafe': 'Café',
                'platano': 'Plátano',
                'maiz': 'Maíz',
                'frijol': 'Frijol',
                'hortalizas': 'Hortalizas',
                'frutales': 'Frutales',
                'cacao': 'Cacao'
            };
            return crops[cropKey] || cropKey;
        }
        
        // Actualizar estadísticas
        function updateStats() {
            document.getElementById('total-farms').textContent = farmData.length;
            
            // Contar beneficiarios únicos
            const uniqueBeneficiaries = new Set(farmData.map(data => data.beneficiary));
            document.getElementById('total-beneficiaries').textContent = uniqueBeneficiaries.size;
            
            // Actualizar última actualización
            document.getElementById('last-update').textContent = 'Hoy';
        }
        
        // Actualizar marcadores en el mapa
        function updateMapMarkers() {
            // Eliminar todos los marcadores existentes del clúster
            farmCluster.clearLayers();
            
            // Añadir nuevos marcadores al clúster
            farmData.forEach(data => {
                const marker = L.marker(data.coords, {
                    icon: L.divIcon({
                        className: 'farm-marker',
                        html: `<div style="background-color:${editingId === data.id ? '#ffc107' : '#e91e63'}; width:22px; height:22px; border-radius:50%; border:2px solid white; box-shadow:0 0 8px rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center;">
                                <i class="fas fa-tractor" style="color:white; font-size:10px;"></i>
                           </div>`,
                        iconSize: [26, 26]
                    })
                });
                
                marker.bindPopup(`
                    <b>${data.farm}</b><br>
                    Beneficiario: ${data.beneficiary}<br>
                    Cultivo: ${getCropName(data.crop)}<br>
                    Altura: ${data.elevation} m<br>
                    Fecha: ${data.date}<br>
                    <div style="margin-top:8px; text-align:center;">
                        <button class="btn-popup-print" data-id="${data.id}" style="background:#1565c0; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;">
                            <i class="fas fa-print"></i> Imprimir
                        </button>
                    </div>
                `);
                
                // Evento para editar al hacer clic en el marcador
                marker.on('click', function() {
                    editData(data.id);
                });
                
                farmCluster.addLayer(marker);
            });
        }
        
        // Actualizar lista de datos
        function updateDataList(filter = '') {
            const dataList = document.getElementById('data-list');
            dataList.innerHTML = '';
            
            const filteredData = farmData.filter(data => 
                data.beneficiary.toLowerCase().includes(filter.toLowerCase()) || 
                data.farm.toLowerCase().includes(filter.toLowerCase())
            );
            
            if (filteredData.length === 0) {
                dataList.innerHTML = '<div class="data-item"><p>No se encontraron registros</p></div>';
                return;
            }
            
            filteredData.forEach(data => {
                const item = document.createElement('div');
                item.className = 'data-item';
                item.innerHTML = `
                    <h3>${data.farm}</h3>
                    <p><strong>Beneficiario:</strong> ${data.beneficiary}</p>
                    <p><strong>Cultivo:</strong> ${getCropName(data.crop)}</p>
                    <p><strong>Altura:</strong> ${data.elevation} m</p>
                    <p><strong>Ubicación:</strong> ${data.coords.lat.toFixed(6)}, ${data.coords.lng.toFixed(6)}</p>
                    <p><strong>Fecha:</strong> ${data.date}</p>
                    <div class="actions">
                        <button class="btn btn-edit edit-btn" data-id="${data.id}">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="btn btn-delete delete-btn" data-id="${data.id}">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                        <button class="btn btn-print print-btn" data-id="${data.id}">
                            <i class="fas fa-print"></i> Imprimir
                        </button>
                    </div>
                `;
                dataList.appendChild(item);
            });
            
            // Agregar event listeners a los botones
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    editData(id);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    deleteData(id);
                });
            });
            
            // Agregar event listeners a los botones de impresión
            document.querySelectorAll('.print-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    const data = farmData.find(d => d.id === id);
                    if (data) {
                        showPrintView(data);
                    }
                });
            });
        }
        
        // Función para editar datos
        function editData(id) {
            const data = farmData.find(item => item.id === id);
            if (!data) return;
            
            // Mostrar formulario
            showPanel('form-panel');
            
            // Rellenar formulario con datos
            document.getElementById('beneficiary').value = data.beneficiary;
            document.getElementById('farm').value = data.farm;
            document.getElementById('crop').value = data.crop;
            document.getElementById('observations').value = data.observations || '';
            
            // Ocultar errores
            document.querySelectorAll('.form-error').forEach(el => el.style.display = 'none');
            
            // Establecer coordenadas y elevación
            currentCoords = data.coords;
            currentElevation = data.elevation;
            document.getElementById('coordinates').textContent = 
                `Lat: ${currentCoords.lat.toFixed(6)}, Lng: ${currentCoords.lng.toFixed(6)}`;
            document.getElementById('elevation-value').textContent = data.elevation;
            
            // Centrar mapa en la ubicación
            map.setView(currentCoords, 15);
            
            // Limpiar marcadores temporales
            clearTempMarkers();
            
            // Añadir marcador temporal para edición
            const marker = L.marker(currentCoords, {
                icon: L.divIcon({
                    className: 'temp-marker',
                    html: '<div style="background-color:#ffc107; width:22px; height:22px; border-radius:50%; border:2px solid white; box-shadow:0 0 8px rgba(0,0,0,0.5);"></div>',
                    iconSize: [26, 26]
                })
            }).addTo(map);
            
            tempMarkers.push(marker);
            
            // Activar modo edición
            editingId = id;
            document.getElementById('cancel-edit-btn').style.display = 'block';
            
            // Actualizar marcadores para resaltar el que se está editando
            updateMapMarkers();
        }
        
        // Cancelar edición
        function cancelEdit() {
            editingId = null;
            document.getElementById('cancel-edit-btn').style.display = 'none';
            
            // Limpiar formulario
            document.getElementById('beneficiary').value = '';
            document.getElementById('farm').value = '';
            document.getElementById('crop').value = '';
            document.getElementById('observations').value = '';
            document.getElementById('coordinates').textContent = 'Haga clic en el mapa para capturar coordenadas';
            document.getElementById('elevation-value').textContent = '--';
            currentCoords = null;
            currentElevation = null;
            
            // Ocultar errores
            document.querySelectorAll('.form-error').forEach(el => el.style.display = 'none');
            
            // Actualizar marcadores
            updateMapMarkers();
            clearTempMarkers();
            
            showToast('Edición cancelada');
        }
        
        // Función para eliminar datos
        function deleteData(id) {
            if (!confirm('¿Eliminar este registro?')) return;
            
            farmData = farmData.filter(item => item.id !== id);
            localStorage.setItem('farmData', JSON.stringify(farmData));
            
            updateMapMarkers();
            updateDataList();
            updateStats();
            
            showToast('Registro eliminado');
        }
        
        // Función para eliminar todos los datos
        function deleteAllData() {
            if (!confirm('¿Eliminar TODOS los registros? Esta acción no se puede deshacer.')) return;
            
            farmData = [];
            localStorage.removeItem('farmData');
            
            updateMapMarkers();
            updateDataList();
            updateStats();
            
            showToast('Todos los registros eliminados');
        }
        
        // Función para limpiar marcadores temporales
        function clearTempMarkers() {
            tempMarkers.forEach(marker => map.removeLayer(marker));
            tempMarkers.length = 0;
        }
        
        // Mostrar panel específico
        function showPanel(panelId) {
            closePanels();
            document.getElementById(panelId).classList.add('active');
            activePanel = panelId;
            
            // Actualizar estado de botones
            document.querySelectorAll('.floating-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`#${panelId.replace('-panel', '-btn')}`).classList.add('active');
        }
        
        // Cerrar todos los paneles
        function closePanels() {
            document.querySelectorAll('.floating-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            activePanel = null;
            
            // Restablecer botones
            document.querySelectorAll('.floating-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        }
        
        // Función para mostrar la ventana de impresión
        function showPrintView(data = null) {
            // Mostrar la ventana de impresión
            document.getElementById('print-overlay').style.display = 'flex';
            
            // Limpiar resultados de búsqueda
            document.getElementById('print-search-results').innerHTML = '<div class="no-results">Ingrese al menos 3 caracteres para buscar</div>';
            document.getElementById('print-search-input').value = '';
            
            // Deshabilitar botón de impresión hasta que se seleccione un beneficiario
            document.getElementById('print-map-btn').disabled = true;
            
            // Mostrar indicador de carga
            document.getElementById('print-map').innerHTML = '<div class="loading-map">Cargando mapa...</div>';
            
            // Si se proporcionan datos, mostrarlos directamente
            if (data) {
                // Retrasar ligeramente para permitir la renderización del overlay
                setTimeout(() => {
                    updatePrintView(data);
                }, 100);
            }
        }
        
        // Función para buscar beneficiarios
        function searchBeneficiaries(searchTerm) {
            const resultsContainer = document.getElementById('print-search-results');
            resultsContainer.innerHTML = '';
            
            if (!searchTerm || searchTerm.length < 3) {
                resultsContainer.innerHTML = '<div class="no-results">Ingrese al menos 3 caracteres para buscar</div>';
                return;
            }
            
            const filteredData = farmData.filter(data => 
                data.beneficiary.toLowerCase().includes(searchTerm.toLowerCase()) || 
                data.farm.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            if (filteredData.length === 0) {
                resultsContainer.innerHTML = '<div class="no-results">No se encontraron resultados</div>';
                return;
            }
            
            filteredData.forEach(data => {
                const resultItem = document.createElement('div');
                resultItem.className = 'print-search-result';
                resultItem.innerHTML = `
                    <h4>${data.beneficiary}</h4>
                    <p><strong>Finca:</strong> ${data.farm}</p>
                    <p><strong>Ubicación:</strong> ${data.coords.lat.toFixed(6)}, ${data.coords.lng.toFixed(6)}</p>
                `;
                
                resultItem.addEventListener('click', function() {
                    updatePrintView(data);
                });
                
                resultsContainer.appendChild(resultItem);
            });
        }
        
        // Función para actualizar la vista de impresión con datos específicos
        function updatePrintView(data) {
            currentPrintData = data;
            
            // Actualizar la información en la ventana de impresión
            document.getElementById('print-farm-name').textContent = data.farm;
            document.getElementById('print-beneficiary').textContent = data.beneficiary;
            document.getElementById('print-crop').textContent = getCropName(data.crop);
            document.getElementById('print-coords').textContent = 
                `Lat: ${data.coords.lat.toFixed(6)}, Lng: ${data.coords.lng.toFixed(6)}`;
            document.getElementById('print-elevation').textContent = data.elevation;
            document.getElementById('print-date').textContent = data.date;
            document.getElementById('print-observations').textContent = data.observations || 'Ninguna';
            document.getElementById('print-current-date').textContent = new Date().toLocaleDateString('es-CO', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Habilitar botón de impresión
            document.getElementById('print-map-btn').disabled = false;
            
            // Inicializar mapa de impresión
            initPrintMap(data);
        }
        
        // Función para inicializar el mapa de impresión
        function initPrintMap(data) {
            // Eliminar mapa existente si hay uno
            if (printMapInstance) {
                printMapInstance.remove();
            }
            
            // Crear nuevo mapa
            printMapInstance = L.map('print-map', {
                zoomControl: false,
                attributionControl: false
            }).setView(data?.coords || [3.4516, -76.5320], 15);
            
            // Añadir capa base con reintentos
            addBaseLayerWithRetry(printMapInstance, 3);
            
            // Añadir círculo de 500 metros
            if (data) {
                L.circle(data.coords, {
                    radius: 500,
                    color: '#3388ff',
                    fillColor: '#3388ff',
                    fillOpacity: 0.2,
                    weight: 2
                }).addTo(printMapInstance);
                
                // Añadir marcador en la ubicación
                L.marker(data.coords, {
                    icon: L.divIcon({
                        className: 'print-marker',
                        html: '<div style="background-color:#e91e63; width:26px; height:26px; border-radius:50%; border:2px solid white; box-shadow:0 0 10px rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center;"><i class="fas fa-map-marker-alt" style="color:white; font-size:14px;"></i></div>',
                        iconSize: [30, 30]
                    })
                }).addTo(printMapInstance);
                
                // Añadir etiqueta del radio
                L.marker(data.coords, {
                    icon: L.divIcon({
                        className: 'radius-label',
                        html: `<div style="background:rgba(255,255,255,0.85); padding:4px 8px; border-radius:4px; font-size:12px; border-left:3px solid #3388ff;">Radio: 500m</div>`,
                        iconSize: [0, 0] // Tamaño cero para usar solo el HTML
                    })
                }).addTo(printMapInstance);
            }
            
            // Forzar recálculo del tamaño
            setTimeout(() => {
                printMapInstance.invalidateSize();
            }, 100);
        }
        
        // Función para añadir capa base con reintentos
        function addBaseLayerWithRetry(mapInstance, retries) {
            try {
                const currentBaseLayer = map.getLayers()[0];
                let baseLayer;
                
                if (currentBaseLayer instanceof L.TileLayer) {
                    baseLayer = L.tileLayer(currentBaseLayer._url, currentBaseLayer.options);
                } else {
                    baseLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: 'Tiles © Esri'
                    });
                }
                
                baseLayer.addTo(mapInstance);
                mapInstance.invalidateSize();
            } catch (error) {
                console.error('Error adding base layer:', error);
                if (retries > 0) {
                    setTimeout(() => addBaseLayerWithRetry(mapInstance, retries - 1), 500);
                } else {
                    // Mostrar mensaje de error
                    document.getElementById('print-map').innerHTML = '<div class="loading-map" style="color: #f44336;">Error cargando el mapa base. Intente nuevamente.</div>';
                }
            }
        }
        
        // Función para imprimir el mapa
        function printMap() {
            if (!currentPrintData) {
                showToast('No hay datos para imprimir', 3000);
                return;
            }
            
            // Crear un div temporal para la impresión
            const printDiv = document.createElement('div');
            printDiv.style.position = 'absolute';
            printDiv.style.left = '-9999px';
            printDiv.style.width = '800px';
            printDiv.style.padding = '20px';
            printDiv.style.background = 'white';
            printDiv.style.zIndex = '5000';
            
            // Construir el contenido HTML para imprimir
            printDiv.innerHTML = `
                <div style="margin-bottom:20px; border-bottom:2px solid #2e7d32; padding-bottom:10px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <h1 style="margin:0; color:#2e7d32;">Mapa del Beneficiario</h1>
                            <p style="margin:5px 0 0 0; color:#666;">Radio de 500 metros alrededor de la ubicación</p>
                        </div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div style="width:50px; height:50px; background:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; color:#2e7d32; font-size:10px; text-align:center; padding:3px; box-shadow:0 2px 4px rgba(0,0,0,0.15);">
                                FNC<br>&<br>CVC
                            </div>
                            <div>
                                <div style="font-size:12px; color:#666;">Geoportal - Seguridad Alimentaria</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="display:flex; gap:20px; margin-bottom:20px;">
                    <div style="flex:1;">
                        <h3 style="color:#2e7d32; margin-top:0;">${currentPrintData.farm}</h3>
                        <p><strong>Beneficiario:</strong> ${currentPrintData.beneficiary}</p>
                        <p><strong>Cultivo:</strong> ${getCropName(currentPrintData.crop)}</p>
                        <p><strong>Ubicación:</strong> ${currentPrintData.coords.lat.toFixed(6)}, ${currentPrintData.coords.lng.toFixed(6)}</p>
                        <p><strong>Altura:</strong> ${currentPrintData.elevation} m</p>
                        <p><strong>Fecha de registro:</strong> ${currentPrintData.date}</p>
                    </div>
                    <div style="flex:1;">
                        <h3 style="color:#2e7d32; margin-top:0;">Información Adicional</h3>
                        <p><strong>Observaciones:</strong> ${currentPrintData.observations || 'Ninguna'}</p>
                        <p><strong>Radio:</strong> 500 metros alrededor de la ubicación</p>
                        <p><strong>Fecha de impresión:</strong> ${new Date().toLocaleDateString('es-CO', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        })}</p>
                    </div>
                </div>
                
                <div id="map-to-print" style="height:500px; width:100%;"></div>
                
                <div style="margin-top:10px; text-align:right; font-size:10px; color:#666;">
                    © Leaflet | OpenStreetMap | Esri
                </div>
            `;
            
            // Añadir el div al documento
            document.body.appendChild(printDiv);
            
            // Inicializar el mapa para imprimir
            const printMap = L.map('map-to-print').setView(currentPrintData.coords, 16);
            
            // Añadir capa base
            const currentBaseLayer = map.getLayers()[0];
            if (currentBaseLayer instanceof L.TileLayer) {
                L.tileLayer(currentBaseLayer._url, currentBaseLayer.options).addTo(printMap);
            } else {
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, Maxar, Earthstar Geographics'
                }).addTo(printMap);
            }
            
            // Añadir círculo de 500 metros
            L.circle(currentPrintData.coords, {
                radius: 500,
                color: '#3388ff',
                fillColor: '#3388ff',
                fillOpacity: 0.2,
                weight: 2
            }).addTo(printMap);
            
            // Añadir marcador en la ubicación
            L.marker(currentPrintData.coords, {
                icon: L.divIcon({
                    className: 'print-marker',
                    html: '<div style="background-color:#e91e63; width:26px; height:26px; border-radius:50%; border:2px solid white; box-shadow:0 0 10px rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center;"><i class="fas fa-map-marker-alt" style="color:white; font-size:14px;"></i></div>',
                    iconSize: [30, 30]
                })
            }).addTo(printMap);
            
            // Esperar a que el mapa se cargue completamente
            setTimeout(() => {
                // Usar html2canvas para capturar el contenido
                html2canvas(printDiv, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    scrollX: 0,
                    scrollY: 0,
                    windowWidth: printDiv.scrollWidth,
                    windowHeight: printDiv.scrollHeight
                }).then(canvas => {
                    // Crear una ventana nueva para imprimir
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write('<html><head><title>Impresión Mapa</title>');
                    printWindow.document.write('<style>body { margin: 0; padding: 0; } img { max-width: 100%; height: auto; }</style>');
                    printWindow.document.write('</head><body style="margin:0;padding:0;">');
                    printWindow.document.write('<img src="' + canvas.toDataURL('image/png') + '">');
                    printWindow.document.write('</body></html>');
                    printWindow.document.close();
                    
                    // Imprimir cuando la imagen esté cargada
                    printWindow.onload = function() {
                        printWindow.print();
                        printWindow.close();
                    };
                    
                    // Eliminar el div temporal
                    document.body.removeChild(printDiv);
                });
            }, 1000);
        }
        
        // Eventos al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar datos existentes
            updateMapMarkers();
            updateDataList();
            updateStats();
            
            // Cargar datos CSV si existen
            updateCSVTableView();
            document.getElementById('csv-count').textContent = csvData.length;
            
            // Añadir control de capas personalizado
            L.control.layers(baseLayers, null, {
                position: 'topright',
                collapsed: false
            }).addTo(map);
            
            // Evento para capturar coordenadas al hacer clic en el mapa
            map.on('click', async function(e) {
                currentCoords = e.latlng;
                document.getElementById('coordinates').textContent = 
                    `Lat: ${currentCoords.lat.toFixed(6)}, Lng: ${currentCoords.lng.toFixed(6)}`;
                
                // Obtener elevación
                document.getElementById('elevation-value').textContent = 'cargando...';
                currentElevation = await getElevation(currentCoords.lat, currentCoords.lng);
                document.getElementById('elevation-value').textContent = currentElevation || '--';
                
                // Limpiar marcadores temporales
                clearTempMarkers();
                
                // Añadir marcador temporal
                const marker = L.marker(currentCoords, {
                    icon: L.divIcon({
                        className: 'temp-marker',
                        html: '<div style="background-color:#4caf50; width:22px; height:22px; border-radius:50%; border:2px solid white; box-shadow:0 0 8px rgba(0,0,0,0.5);"></div>',
                        iconSize: [26, 26]
                    })
                }).addTo(map);
                
                tempMarkers.push(marker);
            });
            
            // Botones de control flotantes
            document.getElementById('form-btn').addEventListener('click', function() {
                if (activePanel === 'form-panel') closePanels();
                else showPanel('form-panel');
            });
            
            document.getElementById('data-btn').addEventListener('click', function() {
                if (activePanel === 'data-panel') closePanels();
                else showPanel('data-panel');
            });
            
            document.getElementById('csv-btn').addEventListener('click', function() {
                if (activePanel === 'csv-panel') closePanels();
                else showPanel('csv-panel');
            });
            
            document.getElementById('location-btn').addEventListener('click', locateUser);
            document.getElementById('help-btn').addEventListener('click', function() {
                document.getElementById('instructions-overlay').style.display = 'flex';
            });
            
            document.getElementById('print-view-btn').addEventListener('click', showPrintView);
            
            document.getElementById('close-instructions').addEventListener('click', function() {
                document.getElementById('instructions-overlay').style.display = 'none';
            });
            
            // Botones de cerrar panel
            document.querySelectorAll('.close-panel-btn').forEach(btn => {
                btn.addEventListener('click', closePanels);
            });
            
            document.getElementById('save-btn').addEventListener('click', saveData);
            document.getElementById('cancel-edit-btn').addEventListener('click', cancelEdit);
            document.getElementById('search-btn').addEventListener('click', function() {
                const searchTerm = document.getElementById('search-input').value;
                updateDataList(searchTerm);
            });
            
            document.getElementById('export-btn').addEventListener('click', exportToCSV);
            document.getElementById('clear-all-btn').addEventListener('click', deleteAllData);
            
            document.getElementById('search-input').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    updateDataList(this.value);
                }
            });
            
            // Eventos para la ventana de impresión
            document.getElementById('print-map-btn').addEventListener('click', printMap);
            document.getElementById('close-print-btn').addEventListener('click', function() {
                document.getElementById('print-overlay').style.display = 'none';
            });
            document.getElementById('print-close-btn').addEventListener('click', function() {
                document.getElementById('print-overlay').style.display = 'none';
            });
            
            // Evento para buscar beneficiarios en el panel de impresión
            document.getElementById('print-search-input').addEventListener('input', function() {
                searchBeneficiaries(this.value);
            });
            
            // Event delegation para botones de impresión en popups
            map.on('popupopen', function(e) {
                const popup = e.popup;
                const content = popup.getElement();
                const printBtn = content.querySelector('.btn-popup-print');
                if (printBtn) {
                    printBtn.addEventListener('click', function() {
                        const id = parseInt(this.getAttribute('data-id'));
                        const data = farmData.find(d => d.id === id);
                        if (data) {
                            showPrintView(data);
                        }
                    });
                }
            });
            
            // Actualizar fecha actual
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('es-CO', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        });
        
        // Función para geolocalización
        function locateUser() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        // Centrar mapa en la ubicación del usuario
                        map.setView(userLocation, 15);
                        
                        // Limpiar marcadores de ubicación anteriores
                        if (userMarker) map.removeLayer(userMarker);
                        
                        // Añadir nuevo marcador
                        userMarker = L.marker(userLocation, {
                            icon: L.divIcon({
                                className: 'user-marker',
                                html: '<div style="background-color:#ff9800; width:22px; height:22px; border-radius:50%; border:2px solid white; box-shadow:0 0 8px rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center;"><i class="fas fa-user" style="color:white; font-size:10px;"></i></div>',
                                iconSize: [26, 26]
                            })
                        }).addTo(map);
                        
                        userMarker.bindPopup('Su ubicación actual').openPopup();
                        
                        showToast('Ubicación encontrada');
                    },
                    error => {
                        showToast('Error: ' + error.message, 4000);
                    }
                );
            } else {
                showToast('Geolocalización no soportada', 4000);
            }
        }
        
        // Función para exportar datos a CSV
        function exportToCSV() {
            if (farmData.length === 0) {
                showToast('No hay datos para exportar', 4000);
                return;
            }
            
            // Crear encabezados CSV
            let csvContent = "Beneficiario,Finca,Cultivo,Altura (m),Latitud,Longitud,Observaciones,Fecha\n";
            
            // Añadir datos
            farmData.forEach(data => {
                csvContent += `"${data.beneficiary}","${data.farm}","${getCropName(data.crop)}",${data.elevation},${data.coords.lat},${data.coords.lng},"${data.observations || ''}","${data.date}"\n`;
            });
            
            // Crear archivo CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `datos_fincas_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('Datos exportados a CSV');
        }
        
        // Actualizar vista de tabla CSV
        function updateCSVTableView() {
            const container = document.getElementById('csv-table-container');
            if (csvData.length === 0) {
                container.innerHTML = '<div class="data-item"><p>No hay datos CSV cargados</p></div>';
                return;
            }
            
            let tableHTML = `
                <table class="csv-table">
                    <thead>
                        <tr>
                            <th>Beneficiario</th>
                            <th>Finca</th>
                            <th>Cultivo</th>
                            <th>Latitud</th>
                            <th>Longitud</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            csvData.forEach(row => {
                tableHTML += `
                    <tr>
                        <td>${row.beneficiario || ''}</td>
                        <td>${row.finca || ''}</td>
                        <td>${row.cultivo || ''}</td>
                        <td>${row.latitud.toFixed(6)}</td>
                        <td>${row.longitud.toFixed(6)}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
        }
    </script>
</body>
</html>
